<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 使用映射接口的方式， 命名空间的值必须与映射接口的全限定名一致 -->
<mapper namespace="com.jy.vote.mapper.SubjectMapping">
	<!-- 分页查询 -->
	<resultMap type="VoteList" id="VoteListMap">
		<id column="total" property="total"/>
		<collection property="subjects" column="vsId" ofType="VoteSubject">
			<id column="vsId" property="vsId"/>
			<result column="vsvuId" property="vsvuId"/>
			<result column="vsTitle" property="vsTitle"/>
			<result column="vsType" property="vsType"/>
			<result column="vsBeginTime" property="vsBeginTime"/>
			<result column="optionCount" property="optionCount"/>
			<result column="voteAllCount" property="voteAllCount"/>
		</collection>
	</resultMap>
	<select id="getSubjectListByPage" parameterType="int" resultMap="VoteListMap"> 
		select
		(select count(1) from VoteSubject where vsStatus=1) total, 
		nn.* from
		(
		select rownum rn,a.* from
		(
		select vs.*,
		(select count(1) from VoteOption where vsId=vs.vsId) optionCount,
		(select count(1) from VoteItem where vsId=vs.vsId) voteAllCount
		from VoteSubject vs where vsStatus=1 order by vsBeginTime desc) a 
		where #{0}*#{1}>=rownum ) nn
		where rn>(#{1}-1)*#{0}
	</select>
	
	<sql id="selectSubject">
		select vs.*,
		(select count(1) from VoteOption where vsId=vs.vsId) optionCount,
		(select count(1) from VoteItem where vsId=vs.vsId) voteAllCount
		from VoteSubject vs where vsStatus=1 order by vsBeginTime desc
	</sql>
	<select id="getSubjectAll" parameterType="VoteSubject" resultType="VoteSubject"> 
		<include refid="selectSubject"/>
	</select>
	
	<select id="getSubjectAllById" parameterType="int" resultType="VoteSubject">
		<include refid="selectSubject"/> where vsId=#{vsId}
	</select>
	
	<select id="getCurrSubject" parameterType="int" resultType="VoteSubject"> 
		select vs.*,
		(select count(1) from VoteOption where vsId=vs.vsId) optionCount,
		(select count(1) from VoteItem where vsId=vs.vsId) voteAllCount
		from VoteSubject vs where vs.vsId=#{vsId}
	</select>
	
	<insert id="addNewSubject">
		insert into VoteSubject (vsId, vsvuId,vsTitle, vsType,vsStatus,vsBeginTime)
		values (#{vsId},#{vsvuId}, #{vsTitle}, #{vsType},1,sysdate)
	</insert>
	
	<select id="getCurrSequence" resultType="int">
		select seq_vsubject.nextval vsId from dual
	</select>
</mapper>